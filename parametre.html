<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>World Connect - Paramètres</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #0a0e27;
            color: #e0e0e0;
            padding-top: 70px;
            transition: all 0.3s ease;
            position: relative;
            min-height: 100vh;
        }
        
        /* Canvas Three.js en arrière-plan */
        #three-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }
        
        /* Navbar Kaki */
        .navbar { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            height: 70px; 
            background: linear-gradient(135deg, #6b7c3f 0%, #8a9b56 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            padding: 0 24px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            z-index: 1000;
            border-bottom: 3px solid #556b2f;
        }
        
        .navbar-left { 
            color: #fff; 
            font-size: 26px; 
            font-weight: bold; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            letter-spacing: 0.5px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .navbar-left i {
            color: #f0f0f0;
            font-size: 24px;
        }
        
        .navbar-center { 
            display: flex; 
            align-items: center; 
        }
        
        .theme-toggle { 
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%; 
            width: 44px; 
            height: 44px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover { 
            background: rgba(255,255,255,0.25);
            transform: scale(1.05) rotate(15deg);
        }
        
        .theme-toggle i { 
            font-size: 20px; 
            color: #fff;
            transition: transform 0.3s ease;
        }
        
        .navbar-right { 
            display: flex; 
            gap: 20px; 
            align-items: center; 
        }
        
        .nav-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 4px; 
            cursor: pointer; 
            color: #fff;
            transition: all 0.3s ease;
            text-decoration: none;
            position: relative;
            padding: 8px 12px;
            border-radius: 10px;
            min-width: 60px;
        }
        
        .nav-item:hover { 
            background: rgba(255,255,255,0.15);
            transform: translateY(-2px);
        }
        
        .nav-item i {
            font-size: 20px;
        }
        
        .nav-item span {
            font-size: 12px;
            font-weight: 500;
        }
        
        .page-title { 
            position: fixed; 
            top: 70px; 
            left: 50%; 
            transform: translateX(-50%);
            background: rgba(15, 20, 40, 0.9);
            backdrop-filter: blur(15px);
            padding: 12px 30px;
            border-radius: 0 0 16px 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 999;
            font-size: 18px;
            font-weight: bold;
            color: #e0e0e0;
            transition: all 0.3s ease;
            max-width: 90%;
            text-align: center;
            border: 1px solid rgba(107, 124, 63, 0.3);
        }
        
        .settings-container { 
            max-width: 700px; 
            margin: 60px auto 40px; 
            padding: 24px;
            position: relative;
            z-index: 2;
        }
        
        .settings-section { 
            background: rgba(15, 20, 40, 0.85);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 28px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(107, 124, 63, 0.3);
            transition: all 0.3s ease;
        }
        
        .settings-section:hover {
            box-shadow: 0 12px 40px rgba(107, 124, 63, 0.2);
            transform: translateY(-2px);
        }
        
        .settings-section h2 { 
            color: #e0e0e0;
            font-size: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(107, 124, 63, 0.3);
        }
        
        .settings-section h2 i { 
            color: #8a9b56;
            font-size: 22px;
        }
        
        .form-group { 
            margin-bottom: 20px;
        }
        
        .form-group label { 
            display: block;
            color: #a0aec0;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-group input { 
            width: 100%;
            padding: 14px 18px;
            border: 2px solid rgba(107, 124, 63, 0.3);
            border-radius: 12px;
            background: rgba(30, 40, 60, 0.6);
            color: #e0e0e0;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus { 
            outline: none;
            border-color: #8a9b56;
            box-shadow: 0 0 0 3px rgba(138, 155, 86, 0.2);
            background: rgba(30, 40, 60, 0.8);
        }
        
        .form-group input::placeholder {
            color: rgba(160, 174, 192, 0.5);
        }
        
        .submit-btn { 
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #6b7c3f 0%, #8a9b56 100%);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(107, 124, 63, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .submit-btn:hover {
            background: linear-gradient(135deg, #8a9b56 0%, #6b7c3f 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(107, 124, 63, 0.6);
        }
        
        .submit-btn:active {
            transform: translateY(0);
        }
        
        .submit-btn i {
            font-size: 18px;
        }
        
        .delete-section { 
            border: 2px solid #ff4757;
            background: rgba(255, 71, 87, 0.1);
            backdrop-filter: blur(15px);
        }
        
        .delete-section h2 {
            color: #ff6b7a;
            border-bottom-color: rgba(255, 71, 87, 0.3);
        }
        
        .delete-section h2 i {
            color: #ff4757;
        }
        
        .verification-string { 
            background: rgba(30, 40, 60, 0.8);
            padding: 16px;
            border-radius: 12px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
            user-select: none;
            margin: 15px 0;
            color: #e0e0e0;
            border: 2px solid rgba(255, 71, 87, 0.3);
            font-size: 14px;
            line-height: 1.6;
        }
        
        .no-copy-input { 
            user-select: none;
        }
        
        .hidden { 
            display: none;
        }
        
        .error-message { 
            color: #ff6b7a;
            font-size: 14px;
            margin-top: 10px;
            display: none;
            padding: 10px;
            background: rgba(255, 71, 87, 0.1);
            border-radius: 8px;
            border-left: 3px solid #ff4757;
        }
        
        .success-message { 
            color: #4ade80;
            font-size: 14px;
            margin-top: 10px;
            display: none;
            padding: 10px;
            background: rgba(74, 222, 128, 0.1);
            border-radius: 8px;
            border-left: 3px solid #4ade80;
        }
        
        .delete-btn {
            background: linear-gradient(135deg, #ff4757 0%, #e04250 100%);
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4);
        }
        
        .delete-btn:hover {
            background: linear-gradient(135deg, #e04250 0%, #ff4757 100%);
            box-shadow: 0 6px 20px rgba(255, 71, 87, 0.6);
        }
        
        .verify-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        
        .verify-btn:hover {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
        }
        
        .info-text {
            color: #a0aec0;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) { 
            .settings-container { 
                padding: 16px;
                margin: 50px auto 30px;
            }
            
            .settings-section { 
                padding: 20px;
            }
            
            .submit-btn { 
                padding: 14px;
                font-size: 15px;
            }
            
            .navbar-left {
                font-size: 20px;
            }
            
            .nav-item span {
                display: none;
            }
            
            .page-title {
                font-size: 16px;
                padding: 10px 20px;
            }
        }
    </style>
</head>
<body>
    <canvas id="three-canvas"></canvas>
    
    <nav class="navbar">
        <div class="navbar-left">
            <i class="fas fa-globe"></i>
            World Connect
        </div>
        <div class="navbar-center">
            <button class="theme-toggle" id="theme-toggle">
                <i class="fas fa-moon" id="theme-icon"></i>
            </button>
        </div>
        <div class="navbar-right">
            <div class="nav-item" onclick="window.location.href='index.html'">
                <i class="fas fa-home"></i>
                <span>Retour</span>
            </div>
        </div>
    </nav>

    <div class="page-title">Paramètres du compte</div>

    <div class="settings-container">
        <div class="settings-section">
            <h2><i class="fas fa-user-edit"></i> Modifier le profil</h2>
            <form id="update-profile-form">
                <div class="form-group">
                    <label for="prenom">Prénom</label>
                    <input type="text" id="prenom" placeholder="Votre prénom" required>
                </div>
                <div class="form-group">
                    <label for="nom">Nom</label>
                    <input type="text" id="nom" placeholder="Votre nom" required>
                </div>
                <div class="form-group">
                    <label for="current-password">Mot de passe actuel (obligatoire)</label>
                    <input type="password" id="current-password" placeholder="••••••••" required>
                </div>
                <button type="submit" class="submit-btn">
                    <i class="fas fa-save"></i> 
                    Enregistrer les modifications
                </button>
                <p class="error-message" id="update-error"></p>
                <p class="success-message" id="update-success"></p>
            </form>
        </div>

        <div class="settings-section delete-section">
            <h2><i class="fas fa-exclamation-triangle"></i> Zone dangereuse</h2>
            <p class="info-text">La suppression de votre compte est irréversible. Toutes vos données seront définitivement perdues.</p>
            <p class="info-text">Pour supprimer votre compte, veuillez taper exactement la chaîne suivante (sans copier-coller) :</p>
            <div class="verification-string" id="verification-string">₽ o hn ₹ ₿₱ ¶v; "(t" &gt;&lt; æ₿β ϟϛχ ποιι θετψψ ηφσϟνχ ζδσξλππ φδρψη κξγφϛ βνμκ ϡλλπο γφζϛϛφθσ ∩∋∈→8≡⊷ εε∨ ⊥∡⌀∞∞ℝℕ∇ 23ϡ⊗⊙⊖⊕∀789↕↑↔∨∧⌈⌉∡⌀√</div>
            <div class="form-group">
                <label for="verification-input">Taper la chaîne de vérification :</label>
                <input type="text" id="verification-input" class="no-copy-input" placeholder="Tapez la chaîne ici..." onpaste="return false" oncopy="return false" required>
            </div>
            <button id="verify-btn" class="submit-btn verify-btn">
                <i class="fas fa-check"></i> 
                Vérifier la chaîne
            </button>
            <div id="delete-confirm" class="hidden" style="margin-top: 20px;">
                <div class="form-group">
                    <label for="delete-password">Confirmez avec votre mot de passe :</label>
                    <input type="password" id="delete-password" placeholder="••••••••" required>
                </div>
                <button id="delete-btn" class="submit-btn delete-btn">
                    <i class="fas fa-trash"></i> 
                    Supprimer définitivement mon compte
                </button>
            </div>
            <p class="error-message" id="delete-error"></p>
            <p class="success-message" id="delete-success"></p>
        </div>
    </div>

    <script src="supabaseClient.js"></script>

    <script>
        // ==================== THREE.JS ANIMATION ====================
        const canvas = document.getElementById('three-canvas');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
        
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        camera.position.z = 50;

        // Particules bleues
        const particlesGeometry = new THREE.BufferGeometry();
        const particlesCount = 3000;
        const posArray = new Float32Array(particlesCount * 3);
        
        for(let i = 0; i < particlesCount * 3; i++) {
            posArray[i] = (Math.random() - 0.5) * 150;
        }
        
        particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        
        const particlesMaterial = new THREE.PointsMaterial({
            size: 0.3,
            color: 0x4a90e2,
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending
        });
        
        const particlesMesh = new THREE.Points(particlesGeometry, particlesMaterial);
        scene.add(particlesMesh);

        // Lignes de connexion
        const linesGroup = new THREE.Group();
        scene.add(linesGroup);
        
        function createConnectionLines() {
            for(let i = 0; i < 80; i++) {
                const geometry = new THREE.BufferGeometry();
                const positions = new Float32Array(6);
                
                positions[0] = (Math.random() - 0.5) * 100;
                positions[1] = (Math.random() - 0.5) * 100;
                positions[2] = (Math.random() - 0.5) * 100;
                positions[3] = (Math.random() - 0.5) * 100;
                positions[4] = (Math.random() - 0.5) * 100;
                positions[5] = (Math.random() - 0.5) * 100;
                
                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                
                const material = new THREE.LineBasicMaterial({
                    color: 0x3a7bc8,
                    transparent: true,
                    opacity: 0.2
                });
                
                const line = new THREE.Line(geometry, material);
                linesGroup.add(line);
            }
        }
        
        createConnectionLines();

        // Sphère centrale
        const sphereGeometry = new THREE.SphereGeometry(8, 32, 32);
        const sphereMaterial = new THREE.MeshBasicMaterial({
            color: 0x2e5c8a,
            wireframe: true,
            transparent: true,
            opacity: 0.3
        });
        const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
        scene.add(sphere);

        // Animation
        let time = 0;
        function animate() {
            requestAnimationFrame(animate);
            time += 0.001;
            
            particlesMesh.rotation.y = time * 0.3;
            particlesMesh.rotation.x = time * 0.2;
            
            sphere.rotation.y = time * 0.5;
            sphere.rotation.x = time * 0.3;
            
            linesGroup.rotation.y = time * 0.2;
            linesGroup.rotation.z = time * 0.1;
            
            particlesMaterial.opacity = 0.5 + Math.sin(time * 2) * 0.3;
            
            renderer.render(scene, camera);
        }
        
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // ==================== SETTINGS LOGIC ====================
        const { supabase, getCurrentUser, getUserProfile } = window.supabaseClient || {};

        let currentUser = null;
        let userProfile = null;
        let profileSubscription = null;

        const verificationString = document.getElementById('verification-string').textContent.trim();

        // Theme toggle
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const body = document.body;
        const savedTheme = localStorage.getItem('theme') || 'light';
        
        if (savedTheme === 'dark') {
            themeIcon.classList.replace('fa-moon', 'fa-sun');
        }
        
        themeToggle.addEventListener('click', () => {
            if (themeIcon.classList.contains('fa-moon')) {
                themeIcon.classList.replace('fa-moon', 'fa-sun');
                localStorage.setItem('theme', 'dark');
            } else {
                themeIcon.classList.replace('fa-sun', 'fa-moon');
                localStorage.setItem('theme', 'light');
            }
        });

        // Helpers
        async function getCurrentUserSafe() {
            if (typeof getCurrentUser === 'function') {
                try {
                    const u = await getCurrentUser();
                    if (u && u.user) return u.user;
                    return u;
                } catch (e) {
                    console.warn('getCurrentUser() helper failed', e);
                }
            }
            if (supabase && supabase.auth) {
                const { data, error } = await supabase.auth.getUser();
                if (error) throw error;
                return data.user;
            }
            return null;
        }

        async function getUserProfileSafe(userId) {
            if (!userId) return null;
            if (typeof getUserProfile === 'function') {
                try {
                    const profile = await getUserProfile(userId);
                    if (profile && profile.data) return profile.data;
                    return profile;
                } catch (e) {
                    console.warn('getUserProfile() helper failed', e);
                }
            }
            const { data, error } = await supabase
                .from('users_profile')
                .select('user_id, prenom, nom, role')
                .eq('user_id', userId)
                .maybeSingle();
            if (error) throw error;
            return data;
        }

        async function verifyPassword(email, password) {
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });
            if (error) throw error;
            return data;
        }

        // Subscription en temps réel pour le profil
        function subscribeToProfile(userId) {
            if (profileSubscription) supabase.removeChannel(profileSubscription);

            profileSubscription = supabase.channel(`profile-${userId}`)
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'users_profile',
                    filter: `user_id=eq.${userId}`
                }, (payload) => {
                    // Mise à jour en temps réel du profil
                    userProfile = payload.new;
                    document.getElementById('prenom').value = userProfile.prenom || '';
                    document.getElementById('nom').value = userProfile.nom || '';
                })
                .subscribe();
        }

        async function init() {
            try {
                const u = await getCurrentUserSafe();
                if (!u) {
                    window.location.href = 'connexion.html';
                    return;
                }
                currentUser = u;
                userProfile = await getUserProfileSafe(currentUser.id);

                if (userProfile) {
                    document.getElementById('prenom').value = userProfile.prenom || '';
                    document.getElementById('nom').value = userProfile.nom || '';
                    
                    // Activer la synchronisation en temps réel
                    subscribeToProfile(currentUser.id);
                }
            } catch (err) {
                console.error('Init error:', err);
            }
        }

        // Update profile
        document.getElementById('update-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const prenom = document.getElementById('prenom').value.trim();
            const nom = document.getElementById('nom').value.trim();
            const password = document.getElementById('current-password').value;
            const errorElem = document.getElementById('update-error');
            const successElem = document.getElementById('update-success');

            errorElem.style.display = 'none';
            successElem.style.display = 'none';

            if (!password) {
                errorElem.textContent = 'Le mot de passe actuel est obligatoire.';
                errorElem.style.display = 'block';
                return;
            }

            if (!currentUser) {
                errorElem.textContent = 'Utilisateur non connecté.';
                errorElem.style.display = 'block';
                return;
            }

            try {
                await verifyPassword(currentUser.email, password);

                const { data: updated, error: updateError } = await supabase
                    .from('users_profile')
                    .update({ prenom, nom })
                    .eq('user_id', currentUser.id)
                    .select()
                    .maybeSingle();

                if (updateError) throw updateError;

                successElem.textContent = 'Profil mis à jour avec succès.';
                successElem.style.display = 'block';
                userProfile = updated || userProfile;
                document.getElementById('current-password').value = '';
            } catch (err) {
                console.error(err);
                errorElem.textContent = err.message || 'Une erreur est survenue lors de la mise à jour.';
                errorElem.style.display = 'block';
            }
        });

        // Verification string
        document.getElementById('verify-btn').addEventListener('click', (e) => {
            e.preventDefault();
            const input = document.getElementById('verification-input').value.trim();
            const errorElem = document.getElementById('delete-error');
            errorElem.style.display = 'none';

            if (input === verificationString) {
                document.getElementById('delete-confirm').classList.remove('hidden');
            } else {
                errorElem.textContent = 'La chaîne ne correspond pas. Veuillez réessayer.';
                errorElem.style.display = 'block';
            }
        });

        // Delete account
        document.getElementById('delete-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            const password = document.getElementById('delete-password').value;
            const errorElem = document.getElementById('delete-error');
            const successElem = document.getElementById('delete-success');

            errorElem.style.display = 'none';
            successElem.style.display = 'none';

            if (!password) {
                errorElem.textContent = 'Le mot de passe est obligatoire.';
                errorElem.style.display = 'block';
                return;
            }
            if (!currentUser) {
                errorElem.textContent = 'Utilisateur non connecté.';
                errorElem.style.display = 'block';
                return;
            }

            try {
                await verifyPassword(currentUser.email, password);

                const { error: deleteError } = await supabase
                    .from('users_profile')
                    .delete()
                    .eq('user_id', currentUser.id);

                if (deleteError) throw deleteError;

                await supabase.auth.signOut();

                successElem.textContent = 'Compte supprimé avec succès. Redirection...';
                successElem.style.display = 'block';

                setTimeout(() => { window.location.href = 'connexion.html'; }, 1500);
            } catch (err) {
                console.error('Delete error:', err);
                errorElem.textContent = err.message || 'Une erreur est survenue lors de la suppression.';
                errorElem.style.display = 'block';
            }
        });

        window.addEventListener('beforeunload', () => {
            if (profileSubscription) supabase.removeChannel(profileSubscription);
        });

        init();
    </script>
</body>
    </html>
