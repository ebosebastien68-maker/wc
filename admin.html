<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Promotion Admin</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body { font-family: Inter, system-ui, Arial; background:#071023; color:#e6eef6; padding:20px; }
  .card { max-width:900px; margin:auto; background:#0b1220; padding:20px; border-radius:10px; }
  .warning { background:#ff6b6b22; border-left:4px solid #ff6b6b; padding:12px; margin-bottom:15px; border-radius:6px; font-size:13px; }
  textarea { width:100%; min-height:80px; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:#071829; color:inherit; margin-bottom:10px; font-family:monospace; }
  button { padding:8px 16px; border-radius:8px; border:none; cursor:pointer; margin-right:5px; font-weight:600; transition:all 0.2s; }
  button:hover:not(:disabled) { transform:translateY(-1px); box-shadow:0 4px 8px rgba(0,0,0,0.3); }
  button:disabled { opacity:0.5; cursor:not-allowed; }
  .btn-promote { background:#22c55e; color:#04121a; }
  .btn-promote-all { background:#ff6b6b; color:#200; }
  .btn-clear { background:#3b82f6; color:#fff; }
  table { width:100%; margin-top:12px; border-collapse:collapse; display:none; }
  th, td { padding:10px 8px; border-bottom:1px solid rgba(255,255,255,0.04); text-align:left; }
  th { background:rgba(255,255,255,0.02); font-weight:600; }
  #log { background:#06101a; padding:12px; border-radius:8px; margin-top:12px; font-size:13px; max-height:250px; overflow:auto; font-family:monospace; }
  .error { color:#ff6b6b; }
  .success { color:#22c55e; }
  .info { color:#3b82f6; }
  .promoted-row td { background:rgba(34,197,94,0.1); }
</style>
</head>
<body>
<div class="card">
  <h2>üîê Promotion Admin</h2>
  
  <div class="warning">
    <strong>‚ö†Ô∏è ATTENTION :</strong> Cet outil utilise la cl√© service_role. Ne partagez jamais ce fichier et gardez-le hors ligne.
  </div>

  <p>Entrez les emails des utilisateurs √† promouvoir (un par ligne ou s√©par√©s par des virgules).</p>
  <textarea id="emails" placeholder="utilisateur1@exemple.com&#10;utilisateur2@exemple.com&#10;utilisateur3@exemple.com"></textarea>
  <div>
    <button id="findBtn" class="btn-promote">üîç Rechercher</button>
    <button id="promoteAllBtn" class="btn-promote-all" disabled>‚ö° Promouvoir tous</button>
    <button id="clearBtn" class="btn-clear">üóëÔ∏è Effacer</button>
  </div>
  <table id="tbl">
    <thead>
      <tr><th>Nom complet</th><th>Email</th><th>R√¥le actuel</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="log">üìã Logs syst√®me</div>
</div>

<script type="module">
  // Configuration Supabase avec service_role
  const SUPABASE_URL = 'https://dyxncefogemtwgpmberd.supabase.co';
  const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5eG5jZWZvZ2VtdHdncG1iZXJkIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MjQ4ODYxNSwiZXhwIjoyMDc4MDY0NjE1fQ.udXPrWk9nqmEeK-17Dt3EWlZMv072PITazHh_dQLwLU';

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

  const emailsInput = document.getElementById('emails');
  const findBtn = document.getElementById('findBtn');
  const promoteAllBtn = document.getElementById('promoteAllBtn');
  const clearBtn = document.getElementById('clearBtn');
  const tbl = document.getElementById('tbl');
  const tbody = tbl.querySelector('tbody');
  const logEl = document.getElementById('log');

  let usersData = [];

  function uiLog(msg, type = 'info'){
    const t = new Date().toLocaleTimeString();
    const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'info' ? 'info' : '';
    const logLine = document.createElement('div');
    logLine.className = className;
    logLine.textContent = `[${t}] ${msg}`;
    logEl.insertBefore(logLine, logEl.firstChild);
    console.log(`[${t}]`, msg);
  }

  function normalizeEmails(raw){
    return raw.split(/[\n,;]+/).map(s=>s.trim().toLowerCase()).filter(Boolean);
  }

  async function fetchUserByEmail(email){
    try {
      uiLog(`üîé Recherche de ${email}...`, 'info');
      
      // √âtape 1: R√©cup√©rer l'utilisateur depuis auth.users
      const { data: authUser, error: authError } = await supabase.auth.admin.listUsers();
      
      if (authError) {
        uiLog(`Erreur auth: ${authError.message}`, 'error');
        return { data: null, error: authError };
      }

      // Trouver l'utilisateur par email
      const user = authUser.users.find(u => u.email?.toLowerCase() === email.toLowerCase());
      
      if (!user) {
        uiLog(`‚ùå ${email} non trouv√© dans auth.users`, 'error');
        return { data: null, error: new Error('User not found') };
      }

      // √âtape 2: R√©cup√©rer le profil depuis users_profile
      const { data: profile, error: profileError } = await supabase
        .from('users_profile')
        .select('user_id, role, prenom, nom')
        .eq('user_id', user.id)
        .maybeSingle();

      if (profileError) {
        uiLog(`Erreur profil: ${profileError.message}`, 'error');
        return { data: null, error: profileError };
      }

      if (!profile) {
        uiLog(`‚ö†Ô∏è Profil manquant pour ${email}`, 'error');
        return { data: null, error: new Error('Profile not found') };
      }

      return { 
        data: {
          user_id: user.id,
          email: user.email,
          role: profile.role,
          prenom: profile.prenom,
          nom: profile.nom
        }, 
        error: null 
      };

    } catch (err) {
      uiLog(`Exception pour ${email}: ${err.message}`, 'error');
      return { data: null, error: err };
    }
  }

  async function updateRoleToAdmin(user_id){
    try {
      const { data, error } = await supabase
        .from('users_profile')
        .update({ role: 'admin' })
        .eq('user_id', user_id)
        .select();
      
      return { data, error };
    } catch (err) {
      return { data: null, error: err };
    }
  }

  async function promoteUser(userId, email, displayName, rowIndex){
    uiLog(`‚ö° Promotion de ${displayName || email}...`, 'info');
    const res = await updateRoleToAdmin(userId);
    
    if(res.error) { 
      uiLog(`‚ùå Erreur pour ${email}: ${res.error.message}`, 'error'); 
      return false;
    }
    
    uiLog(`‚úÖ ${displayName || email} promu admin avec succ√®s`, 'success');
    
    const userIndex = usersData.findIndex(u => u.id === userId);
    if(userIndex !== -1) usersData[userIndex].role = 'admin';
    
    const rows = tbody.querySelectorAll('tr');
    if(rows[rowIndex]) {
      rows[rowIndex].classList.add('promoted-row');
      rows[rowIndex].children[2].innerHTML = '<strong style="color:#22c55e">admin</strong>';
      const btn = rows[rowIndex].querySelector('.prom');
      if(btn) {
        btn.disabled = true;
        btn.textContent = '‚úì Promu';
        btn.style.background = '#22c55e';
      }
    }
    return true;
  }

  function renderTable(users){
    usersData = users;
    tbody.innerHTML = '';
    
    users.forEach((u, idx) => {
      const tr = document.createElement('tr');
      const hasButton = u.id && u.role !== 'admin';
      const displayName = u.prenom && u.nom ? `${u.prenom} ${u.nom}` : '-';
      
      tr.innerHTML = `
        <td><strong>${displayName}</strong></td>
        <td style="font-size:13px;">${u.email}</td>
        <td><strong>${u.role ?? '-'}</strong></td>
        <td>${hasButton ? '<button class="prom btn-promote">Promouvoir</button>' : (u.role === 'admin' ? '<span style="color:#22c55e">‚úì D√©j√† admin</span>' : '<span style="color:#ff6b6b">Non trouv√©</span>')}</td>
      `;
      tbody.appendChild(tr);
      
      if(hasButton){
        tr.querySelector('.prom').addEventListener('click', async (e) => {
          e.target.disabled = true;
          await promoteUser(u.id, u.email, displayName, idx);
        });
      }
    });
  }

  findBtn.addEventListener('click', async () => {
    const emails = normalizeEmails(emailsInput.value);
    if (!emails.length) { 
      uiLog('‚ö†Ô∏è Aucun email saisi', 'error'); 
      return; 
    }
    
    uiLog(`üîç Recherche de ${emails.length} profil(s)...`, 'info');
    findBtn.disabled = true;
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">‚è≥ Recherche en cours...</td></tr>';
    tbl.style.display = 'table';

    const found = [];
    
    for(const email of emails){
      const { data, error } = await fetchUserByEmail(email);
      
      if(error || !data){ 
        found.push({
          email: email, 
          id: null, 
          role: null,
          prenom: null,
          nom: null
        });
      } else {
        found.push({ 
          email: data.email,
          id: data.user_id, 
          role: data.role,
          prenom: data.prenom,
          nom: data.nom
        });
        const status = data.role === 'admin' ? '(d√©j√† admin)' : '(user)';
        uiLog(`‚úì ${email} trouv√© ${status}`, 'success');
      }
    }

    renderTable(found);
    
    const promotable = found.filter(f => f.id && f.role !== 'admin').length;
    const notFound = found.filter(f => !f.id).length;
    const alreadyAdmin = found.filter(f => f.id && f.role === 'admin').length;
    
    promoteAllBtn.disabled = promotable === 0;
    
    if(promotable > 0) {
      uiLog(`‚úÖ ${promotable} utilisateur(s) pr√™t(s) √† √™tre promu(s)`, 'success');
    }
    if(alreadyAdmin > 0) {
      uiLog(`‚ÑπÔ∏è ${alreadyAdmin} utilisateur(s) d√©j√† admin`, 'info');
    }
    if(notFound > 0) {
      uiLog(`‚ö†Ô∏è ${notFound} email(s) non trouv√©(s)`, 'error');
    }
    
    findBtn.disabled = false;
  });

  promoteAllBtn.addEventListener('click', async () => {
    const toPromote = usersData.filter(u => u.id && u.role !== 'admin');
    if(!toPromote.length) return;
    
    const names = toPromote.map(u => {
      const name = u.prenom && u.nom ? `${u.prenom} ${u.nom}` : u.email;
      return `‚Ä¢ ${name}`;
    }).join('\n');
    
    if(!confirm(`‚ö†Ô∏è CONFIRMATION REQUISE\n\nPromouvoir ${toPromote.length} utilisateur(s) en administrateur ?\n\n${names}\n\nCette action est irr√©versible.`)) return;
    
    promoteAllBtn.disabled = true;
    findBtn.disabled = true;
    uiLog(`üöÄ D√©but de la promotion massive de ${toPromote.length} utilisateur(s)`, 'info');
    
    let success = 0;
    for(let i = 0; i < toPromote.length; i++){
      const user = toPromote[i];
      const rowIndex = usersData.findIndex(u => u.id === user.id);
      const displayName = user.prenom && user.nom ? `${user.prenom} ${user.nom}` : user.email;
      const result = await promoteUser(user.id, user.email, displayName, rowIndex);
      if(result) success++;
      await new Promise(r => setTimeout(r, 400));
    }
    
    uiLog(`üéâ Promotion termin√©e: ${success}/${toPromote.length} r√©ussie(s)`, 'success');
    promoteAllBtn.disabled = true;
    findBtn.disabled = false;
  });

  clearBtn.addEventListener('click', () => {
    emailsInput.value = '';
    tbody.innerHTML = '';
    tbl.style.display = 'none';
    usersData = [];
    promoteAllBtn.disabled = true;
    uiLog('üóëÔ∏è Interface r√©initialis√©e', 'info');
  });

  uiLog('‚úÖ Interface pr√™te - Recherche par email activ√©e');
  uiLog('‚ö†Ô∏è Service role key active - Gardez ce fichier s√©curis√©', 'error');
</script>
</body>
</html>
