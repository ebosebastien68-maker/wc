<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bulk Reactions ‚Äî X</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f5f7fb;padding:20px}
  .box{max-width:850px;margin:20px auto;background:#fff;padding:20px;border-radius:10px}
  input,button{font-size:16px;padding:10px;border-radius:8px;border:1px solid #ddd}
  button{cursor:pointer;background:#11998e;color:#fff;border:none}
  .result{margin-top:12px;padding:12px;border-radius:8px;display:none}
  .success{background:#e6ffed;border-left:4px solid #28a745}
  .error{background:#fff0f0;border-left:4px solid #dc3545}
</style>
</head>
<body>
  <div class="box">
    <h2>Ajout instantan√© de r√©actions</h2>
    <label>Article ID</label><input id="articleId" type="text" placeholder="ee2abbde-..." /><br/><br/>
    <label>Like</label><input id="like" type="number" value="0" /><br/><br/>
    <label>Love</label><input id="love" type="number" value="0" /><br/><br/>
    <label>Rire</label><input id="rire" type="number" value="0" /><br/><br/>
    <label>Col√®re</label><input id="colere" type="number" value="0" /><br/><br/>
    <button id="run">üöÄ Ex√©cuter</button>

    <div id="result" class="result"></div>
  </div>

<script>
const EDGE_URL = 'https://eqnvbmkdrnssbiwalocr.supabase.co/functions/v1/add-reactions-bulk-'; // v√©rifie slug exact
const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY_OR_TEMP_JWT'; // remplace ici

const btn = document.getElementById('run');
const result = document.getElementById('result');

function show(success, html){
  result.style.display = 'block';
  result.className = 'result ' + (success ? 'success':'error');
  result.innerHTML = html;
}

btn.addEventListener('click', async () => {
  result.style.display='none';
  const article_id = document.getElementById('articleId').value.trim();
  const like = Number(document.getElementById('like').value) || 0;
  const love = Number(document.getElementById('love').value) || 0;
  const rire = Number(document.getElementById('rire').value) || 0;
  const colere = Number(document.getElementById('colere').value) || 0;

  if (!article_id) { alert('Article ID requis'); return; }
  if (like+love+rire+colere === 0) { alert('Entrez au moins une r√©action'); return; }

  btn.disabled = true;
  btn.textContent = '‚è≥ En cours...';

  try {
    // 1) Preflight (automatique) : browser enverra OPTIONS
    const resp = await fetch(EDGE_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        // Mettre Authorization si tu as un JWT plut√¥t que key anon
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'apikey': SUPABASE_ANON_KEY
      },
      body: JSON.stringify({ article_id, reactions: { like, love, rire, colere } })
    });

    if (!resp.ok) {
      const txt = await resp.text().catch(()=> '');
      throw new Error(`HTTP ${resp.status} ${resp.statusText} ${txt ? ' - ' + txt : ''}`);
    }

    const json = await resp.json();
    if (json.success) {
      show(true, `Succ√®s ‚Äî ${json.total_added||0} r√©actions ajout√©es<pre>${JSON.stringify(json.added,null,2)}</pre>`);
    } else {
      show(false, `√âchec : ${json.error||'inconnu'}<pre>${JSON.stringify(json,null,2)}</pre>`);
    }
  } catch (err) {
    console.error('Fetch error:', err);
    show(false, `Erreur r√©seau/CORS : ${err.message}`);
  } finally {
    btn.disabled = false;
    btn.textContent = 'üöÄ Ex√©cuter';
  }
});
</script>
</body>
</html>
