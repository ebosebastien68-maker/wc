<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bulk Reactions â€” WorldConnect</title>
  <style>
    /* Styles propres et responsives */
    :root{--accent1:#667eea;--accent2:#764ba2;--success:#28a745;--danger:#dc3545}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:linear-gradient(135deg,var(--accent1),var(--accent2));min-height:100vh;padding:28px;color:#111}
    .wrap{max-width:1100px;margin:0 auto;background:#fff;border-radius:16px;padding:28px;box-shadow:0 12px 40px rgba(0,0,0,.12)}
    h1{color:var(--accent1);font-size:24px;margin-bottom:6px}
    p.sub{color:#555;margin-bottom:20px}
    label{display:block;font-weight:600;color:#333;margin-bottom:6px}
    input[type="text"], input[type="number"]{width:100%;padding:12px;border:1px solid #e6e6e6;border-radius:10px;font-size:16px;margin-bottom:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .card{background:linear-gradient(135deg,#f6f8fb,#eef3fb);padding:16px;border-radius:12px;text-align:center}
    .card .icon{font-size:32px;margin-bottom:8px}
    .btn{width:100%;padding:14px;border:none;border-radius:12px;font-weight:700;cursor:pointer;font-size:16px}
    .btn.primary{background:linear-gradient(135deg,#11998e,#38ef7d);color:#fff}
    .btn.primary[disabled]{opacity:.6;cursor:not-allowed}
    .result{margin-top:18px;padding:16px;border-radius:12px;display:none}
    .result.show{display:block}
    .result.success{background:linear-gradient(135deg,#d4edda,#c3e6cb);border-left:6px solid var(--success)}
    .result.error{background:linear-gradient(135deg,#f8d7da,#f5c6cb);border-left:6px solid var(--danger)}
    .result .title{font-weight:800;margin-bottom:6px}
    .details{margin-top:12px;background:#fff;padding:12px;border-radius:8px}
    .detail-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee}
    .detail-row:last-child{border-bottom:none}
    @media(min-width:900px){h1{font-size:28px}}
  </style>
</head>
<body>
  <div class="wrap" role="main">
    <h1>ğŸš€ ContrÃ´le des RÃ©actions â€” BULK</h1>
    <p class="sub">Saisis l'ID de l'article et les quantitÃ©s, puis clique sur ExÃ©cuter. (Test: domaine autorisÃ© cÃ´tÃ© Edge Function)</p>

    <label for="articleId">ğŸ“ Article ID</label>
    <input id="articleId" type="text" placeholder="ex: abc123-def456-ghi789" />

    <div class="grid" style="margin-top:8px">
      <div class="card">
        <div class="icon">ğŸ‘</div>
        <label for="like">Like</label>
        <input id="like" type="number" value="0" min="0" />
      </div>
      <div class="card">
        <div class="icon">â¤ï¸</div>
        <label for="love">Love</label>
        <input id="love" type="number" value="0" min="0" />
      </div>
      <div class="card">
        <div class="icon">ğŸ˜†</div>
        <label for="rire">Rire</label>
        <input id="rire" type="number" value="0" min="0" />
      </div>
      <div class="card">
        <div class="icon">ğŸ˜¡</div>
        <label for="colere">ColÃ¨re</label>
        <input id="colere" type="number" value="0" min="0" />
      </div>
    </div>

    <div style="margin-top:18px">
      <button id="execute" class="btn primary">ğŸš€ EXÃ‰CUTER TOUT (INSTANTANÃ‰)</button>
    </div>

    <div id="resultBox" class="result" aria-live="polite">
      <div class="title" id="resultTitle"></div>
      <div id="resultSubtitle" style="color:#444"></div>
      <div class="details" id="resultDetails"></div>
    </div>
  </div>

  <script>
    // ====== CONFIGURATION ======
    // VÃ©rifie que le slug EXACT correspond Ã  ta function dÃ©ployÃ©e (avec ou sans tiret final)
    const EDGE_URL = 'https://eqnvbmkdrnssbiwalocr.supabase.co/functions/v1/add-reactions-bulk-';
    // Ta clÃ© ANON publique (dÃ©jÃ  fournie)
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxbnZibWtkcm5zc2Jpd2Fsb2NyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MzY1MzcsImV4cCI6MjA4MDMxMjUzN30.EFDSrgAbN5wpIYKD-8srH3mtdHZvm81gzjiqsELgCvY';

    // Ã‰lÃ©ments UI
    const btn = document.getElementById('execute');
    const resultBox = document.getElementById('resultBox');
    const resultTitle = document.getElementById('resultTitle');
    const resultSubtitle = document.getElementById('resultSubtitle');
    const resultDetails = document.getElementById('resultDetails');

    function showResult(success, title, subtitle, detailsHTML = '') {
      resultBox.className = 'result show ' + (success ? 'success' : 'error');
      resultTitle.textContent = title;
      resultSubtitle.textContent = subtitle || '';
      resultDetails.innerHTML = detailsHTML || '';
    }

    function clearResult() {
      resultBox.className = 'result';
      resultTitle.textContent = '';
      resultSubtitle.textContent = '';
      resultDetails.innerHTML = '';
    }

    async function executeBulk() {
      clearResult();

      const article_id = document.getElementById('articleId').value.trim();
      const like = Number(document.getElementById('like').value) || 0;
      const love = Number(document.getElementById('love').value) || 0;
      const rire = Number(document.getElementById('rire').value) || 0;
      const colere = Number(document.getElementById('colere').value) || 0;

      if (!article_id) { alert('Veuillez saisir un Article ID'); return; }
      if (like + love + rire + colere === 0) { alert('Veuillez saisir au moins une rÃ©action'); return; }

      btn.disabled = true;
      btn.textContent = 'â³ ExÃ©cution en cours...';

      try {
        const resp = await fetch(EDGE_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // La clÃ© anon fournie; si tu utilises un JWT temporaire, remplace-la ici
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({
            article_id,
            reactions: { like, love, rire, colere }
          })
        });

        // Gestion basique des erreurs HTTP
        if (!resp.ok) {
          // Essayer de lire le corps (s'il existe)
          const text = await resp.text().catch(()=>'');
          throw new Error(`HTTP ${resp.status} ${resp.statusText} ${text ? ' â€” ' + text : ''}`);
        }

        const json = await resp.json();

        if (json?.success) {
          const total = json.total_added ?? 0;
          showResult(true, 'SuccÃ¨s âœ…', `${total} rÃ©actions ajoutÃ©es`, `
            <div class="detail-row"><strong>ğŸ‘ Likes</strong><span>${json.added?.like ?? 0}</span></div>
            <div class="detail-row"><strong>â¤ï¸ Loves</strong><span>${json.added?.love ?? 0}</span></div>
            <div class="detail-row"><strong>ğŸ˜† Rires</strong><span>${json.added?.rire ?? 0}</span></div>
            <div class="detail-row"><strong>ğŸ˜¡ ColÃ¨res</strong><span>${json.added?.colere ?? 0}</span></div>
          `);
        } else {
          showResult(false, 'Ã‰chec âŒ', json?.error ?? 'Erreur inconnue', `<pre style="white-space:pre-wrap">${JSON.stringify(json,null,2)}</pre>`);
        }
      } catch (err) {
        console.error('Fetch error:', err);
        showResult(false, 'Erreur rÃ©seau / CORS', err.message || String(err), `<pre style="white-space:pre-wrap">${String(err)}</pre>`);
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸš€ EXÃ‰CUTER TOUT (INSTANTANÃ‰)';
      }
    }

    // Attacher l'Ã©vÃ©nement
    btn.addEventListener('click', executeBulk);

    // Optionnel : log utile pour debug
    console.log('Page ready â€” EDGE_URL:', EDGE_URL);
  </script>
</body>
</html>
